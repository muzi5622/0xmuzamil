---
import Hr from "./Hr.astro";
import IconX from "@/assets/icons/IconX.svg";
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconArchive from "@/assets/icons/IconArchive.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import IconMenuDeep from "@/assets/icons/IconMenuDeep.svg";
import LinkButton from "./LinkButton.astro";
import { SITE } from "@/config";

const { pathname } = Astro.url;

const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());
  return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<header>
  <div class="mx-auto flex max-w-app flex-col items-center justify-between sm:flex-row">
    <div class="relative flex w-full items-baseline justify-between bg-background p-4 sm:items-center sm:py-6">
      <a href="/" class="text-2xl font-semibold">{SITE.title}</a>

      <nav class="flex items-center space-x-2">
        <LinkButton href="/posts" class:list={{ "active-nav": isActive("/posts") }}>Posts</LinkButton>
        <LinkButton href="/tags" class:list={{ "active-nav": isActive("/tags") }}>Tags</LinkButton>
        <LinkButton href="/about" class:list={{ "active-nav": isActive("/about") }}>About</LinkButton>

        {SITE.showArchives && (
          <LinkButton href="/archives" class:list={{ "active-nav": isActive("/archives") }}>Archives</LinkButton>
        )}

        <!-- Search Icon Button -->
        <button id="search-btn" aria-label="Search" class="p-2 focus:outline-none">
          <IconSearch />
        </button>
      </nav>
    </div>
  </div>
  <Hr />

  <!-- Header search popup -->
  <div id="header-search-container" class="fixed top-16 right-4 z-50 w-80 max-w-full p-2 bg-background shadow-lg rounded-md hidden">
    <pagefind-ui></pagefind-ui>
  </div>
</header>

<!-- Load Pagefind JS -->
<script type="module" src="/pagefind/pagefind.js"></script>

<script>
  // Toggle header search popup
  const btn = document.getElementById("search-btn");
  const container = document.getElementById("header-search-container");

  btn?.addEventListener("click", () => {
    if (!container) return;
    container.classList.toggle("hidden");
    const input = container.querySelector("input");
    input?.focus();
  });
</script>

<style is:global>
  #header-search-container pagefind-ui {
    display: block;
    margin: 0;
  }
</style>
