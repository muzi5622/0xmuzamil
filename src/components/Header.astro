---
import Hr from "./Hr.astro";
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import LinkButton from "./LinkButton.astro";
import { SITE } from "@/config";

const { pathname } = Astro.url;

const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());
  return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<header>
  <div class="mx-auto flex max-w-app flex-col items-center justify-between sm:flex-row">
    <div class="relative flex w-full items-baseline justify-between bg-background p-4 sm:items-center sm:py-6">
      <a href="/" class="text-2xl font-semibold">{SITE.title}</a>

      <nav class="flex items-center space-x-2">
        <LinkButton href="/posts" class:list={{ "active-nav": isActive("/posts") }}>Posts</LinkButton>
        <LinkButton href="/tags" class:list={{ "active-nav": isActive("/tags") }}>Tags</LinkButton>
        <LinkButton href="/about" class:list={{ "active-nav": isActive("/about") }}>About</LinkButton>

        {SITE.showArchives && (
          <LinkButton href="/archives" class:list={{ "active-nav": isActive("/archives") }}>Archives</LinkButton>
        )}

        <!-- Search Icon Button -->
        <button id="search-btn" aria-label="Search" class="p-2 focus:outline-none">
          <IconSearch />
        </button>
      </nav>
    </div>
  </div>
  <Hr />

  <!-- Header search popup container -->
  <div id="header-search-container" class="fixed top-16 right-4 z-50 w-80 max-w-full p-2 bg-background shadow-lg rounded-md hidden">
    <!-- Pagefind UI will be injected dynamically -->
  </div>
</header>

<!-- Load Pagefind JS -->
<script type="module" src="/pagefind/pagefind.js"></script>

<script type="module">
  const btn = document.getElementById("search-btn");
  const container = document.getElementById("header-search-container");

  let initialized = false;

  btn?.addEventListener("click", async () => {
    if (!container) return;

    // Initialize Pagefind UI only once
    if (!initialized) {
      const pagefindEl = document.createElement("pagefind-ui");
      container.appendChild(pagefindEl);

      // Wait for the custom element to be defined
      await customElements.whenDefined("pagefind-ui");

      // Focus the search input
      const input = pagefindEl.shadowRoot?.querySelector("input") || pagefindEl.querySelector("input");
      input?.focus();

      initialized = true;
    }

    // Toggle visibility
    container.classList.toggle("hidden");

    // Focus input when reopening
    if (!container.classList.contains("hidden")) {
      const input = container.querySelector("input");
      input?.focus();
    }
  });
</script>

<style is:global>
  #header-search-container pagefind-ui {
    display: block;
    margin: 0;
  }
</style>
